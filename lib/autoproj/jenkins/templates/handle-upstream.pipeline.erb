def upstreamDir = "artifacts/upstream"
def fullUpstreamDir = "${fullWorkspaceDir}/${upstreamDir}"
dir(upstreamDir) { deleteDir() }
dir(upstreamDir) {
    <% upstream_jobs.each_key do |upstream_job_name| %>
    step ([$class: 'CopyArtifact',
        projectName: '<%= upstream_job_name %>',
        filter: "<%= upstream_job_name%>-prefix.zip",
        selector: [$class: 'StatusBuildSelector', stable: false]])
    <% end %>
}

def upstreamPrefixDir = null

<% upstream_jobs.each do |upstream_job_name, upstream_package_name| %>
upstreamPrefixDir = sh(script: "${autoproj} locate --no-cache --prefix '<%= upstream_package_name %>'", returnStdout: true).trim()
upstreamPrefixDir = Paths.get(fullWorkspaceDir).relativize(Paths.get(upstreamPrefixDir)).toString()

dir("${upstreamDir}/<%= upstream_job_name %>") {
    unzip zipFile: "${fullUpstreamDir}/<%= upstream_job_name %>-prefix.zip"
    sh "${autoproj} jenkins relativize ./ '@WORKSPACE_ROOT@' '${fullWorkspaceDir}'"
}
dir(upstreamPrefixDir) {
    sh "rsync '${fullUpstreamDir}/<%= upstream_job_name %>/' './' --delete --recursive --safe-links --perms --checksum"
}
<% end %>

