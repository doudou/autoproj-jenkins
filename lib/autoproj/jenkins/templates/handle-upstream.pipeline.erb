def upstream_dir = "artifacts/upstream"
def full_upstream_dir = "${pwd()}/${upstream_dir}"
dir(upstream_dir) { deleteDir() }
dir(upstream_dir) {
    <% upstream_jobs.each_key do |upstream_job_name| %>
    step ([$class: 'CopyArtifact',
        projectName: '<%= upstream_job_name %>',
        filter: "<%= upstream_job_name%>-prefix.zip",
        selector: [$class: 'StatusBuildSelector', stable: false]])
    <% end %>
}

def prefix_dir = null

<% upstream_jobs.each do |upstream_job_name, upstream_package_name| %>
prefix_dir = sh(script: "${autoproj} locate --no-cache --prefix '<%= upstream_package_name %>'", returnStdout: true).trim()
prefix_dir = Paths.get(pwd()).relativize(Paths.get(prefix_dir)).toString()

dir("${upstream_dir}/<%= upstream_job_name %>") {
    unzip zipFile: "${full_upstream_dir}/<%= upstream_job_name %>-prefix.zip"
}
dir(prefix_dir) {
    sh "rsync '${full_upstream_dir}/<%= upstream_job_name %>/' './' --delete --recursive --safe-links --perms --checksum"
}
<% end %>

