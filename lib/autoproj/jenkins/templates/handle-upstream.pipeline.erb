def upstreamDir = "artifacts/upstream"
def fullUpstreamDir = "${fullWorkspaceDir}/${upstreamDir}"
dir(upstreamDir) { deleteDir() }
dir(upstreamDir) {
    <% upstream_jobs.each_key do |upstream_job_name| %>
    step ([$class: 'CopyArtifact',
        projectName: '<%= upstream_job_name %>',
        filter: "<%= upstream_job_name%>-prefix.zip",
        selector: [$class: 'StatusBuildSelector', stable: false]])
    <% end %>
}

def packagePrefixes = sh(script: "${autoproj} locate --no-cache --prefix '<%= package_name %>' <%= upstream_jobs.values.map { |v| "'#{v}'" }.join(" ") %>", returnStdout: true).
    split("\n")
def upstreamPrefixDir = null

<% upstream_jobs.each_with_index do |(upstream_job_name, upstream_package_name), upstream_package_index| %>
upstreamPrefixDir = packagePrefixes[<%= upstream_package_index + 1 %>]
upstreamPrefixDir = Paths.get(fullWorkspaceDir).relativize(Paths.get(upstreamPrefixDir)).toString()

dir("${upstreamDir}/<%= upstream_job_name %>") {
    unzip zipFile: "${fullUpstreamDir}/<%= upstream_job_name %>-prefix.zip"
    sh "${autoproj} jenkins relativize ./ '@WORKSPACE_ROOT@' '${fullWorkspaceDir}'"
}
dir(upstreamPrefixDir) {
    sh "rsync '${fullUpstreamDir}/<%= upstream_job_name %>/' './' --delete --recursive --safe-links --perms --checksum"
}
<% end %>

