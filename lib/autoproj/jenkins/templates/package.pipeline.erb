stage 'wait for upstream jobs to finish'
<%= render_template('abort-if-upstream-is-building.pipeline', upstream_jobs: upstream_jobs) %>

node {
    sh "rm -rf install/log"

    stage 'bootstrap'
    <%= render_template('bootstrap.pipeline', vcs: buildconf_vcs, gemfile: gemfile, autoproj_install_path: autoproj_install_path) %>
    stage 'install upstream artifacts'
    <%= render_template('handle-upstream.pipeline', upstream_jobs: upstream_jobs) %>

    def autoproj = "${pwd()}/dev/.autoproj/bin/autoproj"

    dir('dev') {
        stage 'prepare build'
        <%= render_template("import-#{vcs.type}.pipeline",
                            allow_unused: true,
                            package_dir: package_dir,
                            vcs: vcs,
                            package_name: package_name) %>
        sh "${autoproj} test enable '<%= package_name %>'"
        sh "${autoproj} osdeps '<%= package_name %>' 'pkg-config'"

        stage 'build'
        try {
            sh "${autoproj} build --force --deps=f '<%= package_name %>' -p1"
        }
        catch(err) {
            archive includes: 'install/<%= package_name %>/log/<%= package_name %>-*.log'
            throw(err)
        }
        archive includes: 'install/<%= package_name %>/log/<%= package_name %>-*.log'
    }

    stage 'trigger dependencies'
    <%= render_template('handle-downstream.pipeline',
                        job_name: job_name,
                        artifact_glob: artifact_glob,
                        downstream_jobs: downstream_jobs) %>

    stage 'tests'
    dir('dev') {
        sh "${autoproj} test -p=1 '<%= package_name %>'"
        sh "${autoproj} jenkins postprocess-tests ../test '<%= package_name %>'"
    }
    junit allowEmptyResults: true, keepLongStdio: true, testResults: 'test/*.xml'
}
