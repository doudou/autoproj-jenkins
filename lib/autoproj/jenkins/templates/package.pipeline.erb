stage 'wait for upstream jobs to finish'
<%= render_template('wait-upstream.pipeline', upstream_jobs: upstream_jobs) %>

node {
    stage 'bootstrap'
    <%= render_template('bootstrap.pipeline', vcs: buildconf_vcs) %>
    stage 'install upstream artifacts'
    <%= render_template('handle-upstream.pipeline', upstream_jobs: upstream_jobs) %>

    dir('dev') {
        stage 'prepare build'
        <%= render_template("import-#{vcs.type}.pipeline", package_dir: package_dir, vcs: vcs) %>
        def autoproj = ".autoproj/bin/autoproj"
        sh "${autoproj} osdeps '<%= package_name %>' 'pkg-config'"

        stage 'build'
        sh "${autoproj} build --verbose --force --deps=f '<%= package_name %>'"
    }

    stage 'trigger dependencies'
    <%= render_template('handle-downstream.pipeline',
                        job_name: job_name,
                        artifact_glob: artifact_glob,
                        downstream_jobs: downstream_jobs) %>
}
