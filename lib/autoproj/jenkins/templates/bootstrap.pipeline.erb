def fullWorkspaceDir = pwd()
env.HOME = fullWorkspaceDir
<% if autoproj_install_path %>
sh 'cp -f "<%= autoproj_install_path %>" ./autoproj_install'
<% else %>
sh 'wget -O autoproj_install https://raw.githubusercontent.com/rock-core/autoproj/master/bin/autoproj_install'
<% end %>
def gemfile = "<%= read_and_escape_file gemfile %>"
writeFile file: 'Gemfile', text: gemfile
def config = "<%= render_template('buildconf-config.yml', vcs: vcs, escape: true) %>"
writeFile file: 'seed.yml', text: config
dir('dev') {
    sh "ruby ../autoproj_install --skip-stage2 --seed-config=../seed.yml --gems-path=/var/lib/jenkins/cache/gems --gemfile=../Gemfile"
    <%= render_template("import-#{vcs.type}.pipeline",
                        allow_unused: true,
                        package_dir: 'autoproj',
                        vcs: vcs,
                        credentials: vcs_credentials.for(vcs),
                        package_name: 'autoproj/') %>

    <%= render_template('setup-git-credentials.pipeline', credentials: vcs_credentials[:git]) %>
    sh ".autoproj/bin/aup autoproj/ --force-reset"
}

def autoproj = "${fullWorkspaceDir}/dev/.autoproj/bin/autoproj"
env.AUTOPROJ_CURRENT_ROOT = "${fullWorkspaceDir}/dev"
