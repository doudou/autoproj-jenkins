env.HOME = pwd()
sh 'wget -O autoproj_install https://raw.githubusercontent.com/rock-core/autoproj/master/bin/autoproj_install'
def gemfile = "<%= read_and_escape_file gemfile %>"
writeFile file: 'Gemfile', text: gemfile
def config = "<%= read_and_escape_file 'buildconf-config.yml' %>"
writeFile file: 'seed.yml', text: config
dir('dev') {
    sh "ruby ../autoproj_install --seed-config=../seed.yml --gems-path=/var/lib/jenkins/cache/gems --gemfile=../Gemfile"
    <%= render_template("import-#{vcs.type}.pipeline",
                        allow_unused: true,
                        package_dir: 'autoproj',
                        vcs: vcs,
                        package_name: 'autoproj/') %>
    sh ".autoproj/bin/aup autoproj/"
}

