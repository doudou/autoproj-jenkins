env.HOME = pwd()
<% if autoproj_install_path %>
sh 'cp -f "<%= autoproj_install_path %>" ./autoproj_install'
<% else %>
sh 'wget -O autoproj_install https://raw.githubusercontent.com/rock-core/autoproj/master/bin/autoproj_install'
<% end %>
def gemfile = "<%= read_and_escape_file gemfile %>"
writeFile file: 'Gemfile', text: gemfile
def config = "<%= render_template('buildconf-config.yml', vcs: vcs, escape: true) %>"
writeFile file: 'seed.yml', text: config
dir('dev') {
    sh "ruby ../autoproj_install --skip-stage2 --seed-config=../seed.yml --gems-path=/var/lib/jenkins/cache/gems --gemfile=../Gemfile"
    <%= render_template("import-#{vcs.type}.pipeline",
                        allow_unused: true,
                        package_dir: 'autoproj',
                        vcs: vcs,
                        package_name: 'autoproj/') %>
    sh ".autoproj/bin/aup autoproj/ --force-reset"
}

